const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/NotesToc-BGO-gxsj.js","assets/index-KKYn1hr3.js","assets/vendor-B7FnPyzq.js","assets/index-DyUq36P8.css","assets/OffloadModal-BCbudLjD.js","assets/storage-CLUXANlV.js"])))=>i.map(i=>d[i]);
import{c as P,r as n,j as e,H as T,J as W,K as J,O as X,Q as Y,E as Z,f as $,D as ee,d as g,V as te,L as se,u as ie,m as V,_ as H}from"./index-KKYn1hr3.js";import{S as ae}from"./server-B0p-S84h.js";import{H as F}from"./hard-drive-CgeX8fma.js";import"./vendor-B7FnPyzq.js";/**
 * @license lucide-react v0.564.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],q=P("cloud-upload",ne);/**
 * @license lucide-react v0.564.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],oe=P("ellipsis-vertical",le),re=["zip","rar","7z","tar","gz","bz2","xz","iso"],ce=({item:o,orphaned:E,linkedNotes:l,onDelete:w,onNavigateNote:y,storageConfigs:z,onOffload:c,onPreview:k})=>{var M,O;const[N,_]=n.useState(null),[S,L]=n.useState(null),[x,R]=n.useState(!1),[b,f]=n.useState(!1),h=n.useRef(null),m=n.useRef(null),v=o.mimeType.startsWith("image/"),u=((O=(M=o.fileName)==null?void 0:M.split(".").pop())==null?void 0:O.toLowerCase())||"file",U=re.includes(u);n.useEffect(()=>{const t=new IntersectionObserver(([s])=>{s.isIntersecting&&(R(!0),t.disconnect())},{threshold:.1});return h.current&&t.observe(h.current),()=>t.disconnect()},[]),n.useEffect(()=>{const t=s=>{m.current&&!m.current.contains(s.target)&&f(!1)};return b&&document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[b]),n.useEffect(()=>{if(!x)return;let t=!0,s="";return(async()=>{if(v)try{const a=await g.getAttachment(o.id);a&&t&&(s=URL.createObjectURL(a.blob),_(s))}catch(a){console.warn("Failed to load image preview",a)}else{if(!navigator.onLine)return;try{const a=`https://api.iconify.design/material-icon-theme/${u}.svg?width=48&height=48`;(await fetch(a)).ok&&t&&L(a)}catch{}}})(),()=>{t=!1,s&&URL.revokeObjectURL(s)}},[x,v,o.id,u]);const D=async()=>{try{const t=await g.getAttachment(o.id);if(t){const s=URL.createObjectURL(t.blob),i=document.createElement("a");i.href=s,i.download=o.fileName,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}}catch{alert("Download failed.")}},j=t=>{t.stopPropagation(),k&&k(o.id)},C=t=>{if(t===0)return"0 B";const s=1024,i=["B","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(s));return parseFloat((t/Math.pow(s,a)).toFixed(1))+" "+i[a]},I=t=>["google_drive","dropbox","onedrive","icloud"].includes(t)?e.jsx(q,{size:14}):t==="webdav"||t==="s3"?e.jsx(ae,{size:14}):e.jsx(F,{size:14});return e.jsxs("div",{ref:h,className:"w-40 bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden flex flex-col group hover:border-indigo-500/50 transition-all relative",children:[e.jsxs("div",{onClick:j,className:"h-24 bg-black/50 flex items-center justify-center relative border-b border-zinc-800/50 cursor-pointer overflow-hidden group/preview",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover/preview:opacity-100 transition-opacity flex items-center justify-center z-10",children:e.jsx(T,{size:24,className:"text-white drop-shadow-lg"})}),v?N?e.jsx("img",{src:N,alt:o.fileName,className:"w-full h-full object-cover"}):e.jsx(W,{className:"text-zinc-700 animate-pulse",size:24}):S?e.jsx("img",{src:S,alt:u,className:"w-12 h-12 opacity-80"}):e.jsx("div",{className:"text-zinc-600",children:U?e.jsx(J,{size:24}):e.jsx(X,{size:24})}),E&&e.jsx("div",{className:"absolute top-2 right-2 bg-amber-500/10 text-amber-500 p-1 rounded border border-amber-500/20 z-20",title:"Orphaned File (Not used in notes)",children:e.jsx(Y,{size:12})})]}),e.jsxs("div",{className:"p-3 flex flex-col gap-1 flex-1",children:[e.jsx("h4",{className:"text-xs font-bold text-zinc-300 truncate",title:o.fileName,children:o.fileName}),e.jsx("p",{className:"text-[10px] text-zinc-500 font-mono",children:C(o.size)}),e.jsx("div",{className:"mt-2 min-h-[16px]",children:l.length>0?e.jsxs("button",{onClick:()=>y(l[0]),className:"flex items-center gap-1 text-[9px] text-indigo-400 hover:underline max-w-full",children:[e.jsx(Z,{size:8}),e.jsxs("span",{className:"truncate",children:[l[0]," ",l.length>1&&`+${l.length-1}`]})]}):e.jsx("span",{className:"text-[9px] text-zinc-600 italic",children:"Unused"})})]}),e.jsxs("div",{className:"flex border-t border-zinc-800 divide-x divide-zinc-800 relative",children:[e.jsx("button",{onClick:()=>f(!b),className:`flex-1 py-2 hover:bg-zinc-800 text-zinc-500 hover:text-white transition-colors ${b?"bg-zinc-800 text-white":""}`,title:"Actions",children:e.jsx(oe,{size:14,className:"mx-auto"})}),e.jsx("button",{onClick:()=>w(o.id),className:"flex-1 py-2 hover:bg-red-900/20 text-zinc-500 hover:text-red-400 transition-colors",title:"Delete",children:e.jsx($,{size:14,className:"mx-auto"})})]}),b&&e.jsxs("div",{ref:m,className:"absolute bottom-10 left-2 right-2 bg-zinc-950 border border-zinc-800 rounded-lg shadow-xl z-20 flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-100",children:[e.jsxs("button",{onClick:j,className:"flex items-center gap-2 px-3 py-2 text-[10px] text-zinc-300 hover:bg-zinc-800 hover:text-white text-left transition-colors",children:[e.jsx(T,{size:12})," Preview"]}),e.jsxs("button",{onClick:D,className:"flex items-center gap-2 px-3 py-2 text-[10px] text-zinc-300 hover:bg-zinc-800 hover:text-white text-left transition-colors",children:[e.jsx(ee,{size:12})," Download"]}),z.length>0&&e.jsx("div",{className:"h-px bg-zinc-800 my-0.5"}),z.map(t=>e.jsxs("button",{onClick:()=>{c(o.id,t.id),f(!1)},className:"flex items-center gap-2 px-3 py-2 text-[10px] text-zinc-300 hover:bg-zinc-800 hover:text-white text-left transition-colors",title:`Upload to ${t.name}`,children:[I(t.type),e.jsx("span",{className:"truncate",children:t.type==="custom_http"?"Server":t.type==="webdav"?"WebDAV":t.name})]},t.id))]})]})},de=V.lazy(()=>H(()=>import("./NotesToc-BGO-gxsj.js"),__vite__mapDeps([0,1,2,3]))),xe=V.lazy(()=>H(()=>import("./OffloadModal-BCbudLjD.js"),__vite__mapDeps([4,1,2,3,5]))),pe=({onNavigate:o,onPreview:E})=>{const[l,w]=n.useState([]),[y,z]=n.useState(!0),[c,k]=n.useState({}),[N,_]=n.useState({usage:0,quota:0}),[S,L]=n.useState([]),[x,R]=n.useState(!1),[b,f]=n.useState(!1),[h,m]=n.useState(null),v=n.useRef(null);n.useEffect(()=>{u()},[]);const u=async()=>{z(!0);try{const t=await g.getAttachmentsMeta(),s=await g.getStorageEstimate(),i=await g.getNotes(),a=await g.getSettings(),r={};i.forEach(d=>{const A=d.content,G=A.matchAll(/src="attachment:([^"]+)"/g);for(const B of G){const p=B[1];r[p]||(r[p]=[]),r[p].push({id:d.id,title:d.title})}const K=A.matchAll(/<file-attachment[^>]*id="([^"]+)"/g);for(const B of K){const p=B[1];r[p]||(r[p]=[]),r[p].find(Q=>Q.id===d.id)||r[p].push({id:d.id,title:d.title})}}),w(t.sort((d,A)=>A.createdAt-d.createdAt)),k(r),s&&_(s),a.storageConfigs&&L(a.storageConfigs.filter(d=>d.active))}catch(t){console.error("Failed to load attachment data",t)}finally{z(!1)}},U=async t=>{confirm("Permanently delete this file? This cannot be undone.")&&(await g.deleteAttachment(t),w(s=>s.filter(i=>i.id!==t)))},D=async()=>{const t=l.filter(s=>!c[s.id]||c[s.id].length===0);if(t.length===0){alert("No orphans found.");return}if(confirm(`Delete ${t.length} orphaned files (${j(t.reduce((s,i)=>s+i.size,0))})?`)){for(const s of t)await g.deleteAttachment(s.id);u()}},j=t=>{if(t===0)return"0 B";const s=1024,i=Math.floor(Math.log(t)/Math.log(s)),a=["B","KB","MB","GB"];return parseFloat((t/Math.pow(s,i)).toFixed(1))+" "+a[i]},C=n.useMemo(()=>{const t={};return(x?l.filter(i=>!c[i.id]):l).forEach(i=>{const r=new Date(i.createdAt).toLocaleString("default",{month:"long",year:"numeric"});t[r]||(t[r]=[]),t[r].push(i)}),t},[l,x,c]),I=Math.min(100,N.usage/(1024*1024*1024)*100),M=()=>{const t=x?l.filter(i=>!c[i.id]):l,s=t.flatMap(i=>c[i.id]||[]);m({files:t,linkedNotes:s}),f(!0)},O=(t,s)=>{const i=l.find(a=>a.id===t);i&&(m({files:[i],linkedNotes:c[t]||[],providerId:s}),f(!0))};return e.jsxs("div",{className:"flex h-full bg-black overflow-hidden animate-in fade-in duration-500",children:[e.jsx(n.Suspense,{fallback:null,children:b&&h&&e.jsx(xe,{files:h.files,linkedNotes:h.linkedNotes,initialProviderId:h.providerId,onClose:()=>{f(!1),m(null)},onComplete:()=>{f(!1),m(null),u()}})}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[e.jsx("div",{className:"min-h-16 px-8 py-2 border-b border-indigo-700 bg-zinc-900/50 animate-in fade-in slide-in-from-top-2 duration-300",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-4 justify-between",children:e.jsxs("h1",{className:"text-xl font-bold text-white flex items-center gap-4",children:[e.jsx(F,{size:24,className:"text-indigo-500"}),"Storage Manager"]})}),e.jsxs("div",{className:"flex flex-row gap-2 pt-2",children:[e.jsxs("div",{className:"flex bg-zing-900 border border-zinc-800 items-center gap-2 text-xs py-1",children:[e.jsx("i",{className:"px-3",children:"Total"}),e.jsx("div",{className:"px-2 py-1 rounded-md text-xs font-bold bg-zinc-800 text-indigo-400 shadow-sm flex items-center gap-2",children:l.length})]}),e.jsxs("div",{className:"flex bg-zing-900 border border-zinc-800 items-center gap-2 text-xs py-1",children:[e.jsx("i",{className:"px-3",children:"Space"}),e.jsx("div",{className:"px-2 py-1 rounded-md text-xs font-bold bg-zinc-800 text-indigo-400 shadow-sm flex items-center gap-2",children:j(l.reduce((t,s)=>t+s.size,0))})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"w-64 h-1.5 bg-zinc-800 rounded-full overflow-hidden flex mb-2",children:e.jsx("div",{className:"h-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all duration-1000",style:{width:`${I}%`}})}),e.jsxs("div",{className:"flex justify-between text-[12px] text-zinc-400 font-mono uppercase",children:[e.jsxs("span",{children:["Used: ",j(N.usage)]}),e.jsx("span",{children:"Soft Quota: 1 GB"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("button",{onClick:M,disabled:l.length===0,className:"flex items-center gap-2 px-2 py-2 bg-zinc-900 border border-zinc-800 text-zinc-400 hover:bg-zinc-800 hover:text-white rounded-md text-xs font-bold transition-colors",children:[e.jsx(q,{size:14}),"Select Remote Storage"]}),e.jsxs("button",{onClick:()=>R(!x),className:`flex items-center gap-2 px-2 py-2 rounded-md text-xs font-bold transition-all border ${x?"bg-amber-500/10 border-amber-500/50 text-amber-500":"bg-zinc-900 border-zinc-800 text-zinc-400 hover:bg-zinc-800 hover:text-white"}`,children:[e.jsx(te,{size:14}),x?"Showing Orphans":"Filter Orphans"]}),e.jsxs("button",{onClick:D,className:"flex items-center gap-2 px-2 py-2 bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/30 rounded-md text-xs font-bold transition-colors",children:[e.jsx($,{size:14}),"Clean Orphans"]})]})]})}),e.jsx("div",{ref:v,className:"flex-1 overflow-y-auto p-8 custom-scrollbar space-y-8",children:y?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-zinc-600",children:[e.jsx(se,{size:32,className:"animate-spin mb-4"}),e.jsx("p",{className:"text-xs",children:"Analyzing storage..."})]}):Object.keys(C).length===0?e.jsxs("div",{className:"text-center py-20 text-zinc-600",children:[e.jsx(F,{size:48,className:"mx-auto mb-4 opacity-20"}),e.jsx("p",{children:"No attachments found."})]}):Object.entries(C).map(([t,s])=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"sticky top-0 z-10 py-2 bg-black/90 backdrop-blur border-b border-zinc-800 flex items-center gap-2",children:[e.jsx(ie,{size:14,className:"text-indigo-500"}),e.jsx("h2",{id:`date-${t.replace(/\s+/g,"-").toLowerCase()}`,className:"text-sm font-bold text-zinc-200",children:t}),e.jsxs("span",{className:"text-xs text-zinc-600 font-mono",children:["(",s.length,")"]})]}),e.jsx("div",{className:"flex flex-wrap gap-4",children:s.map(i=>{const a=c[i.id]||[];return e.jsx(ce,{item:i,orphaned:a.length===0,linkedNotes:a.map(r=>r.title),onDelete:U,onNavigateNote:()=>{a.length>0&&o(a[0].id)},storageConfigs:S,onOffload:O,onPreview:E},i.id)})})]},t))})]}),e.jsx("div",{className:"w-16 border-l border-zinc-800 bg-zinc-900/20 hidden xl:block",children:e.jsx("div",{className:"sticky top-0 h-full flex flex-col",children:e.jsx(n.Suspense,{fallback:null,children:!y&&e.jsx(de,{contentRef:v,noteId:"attachments-view"})})})})]})};export{pe as default};
