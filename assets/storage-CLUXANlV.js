import{a7 as N}from"./index-KKYn1hr3.js";const E=new TextEncoder;async function b(t,e){const s=t instanceof ArrayBuffer?await crypto.subtle.importKey("raw",t,{name:"HMAC",hash:"SHA-256"},!1,["sign"]):t;return crypto.subtle.sign("HMAC",s,E.encode(e))}async function x(t){const e=await crypto.subtle.digest("SHA-256",E.encode(t));return Array.from(new Uint8Array(e)).map(s=>s.toString(16).padStart(2,"0")).join("")}function _(t){return Array.from(new Uint8Array(t)).map(e=>e.toString(16).padStart(2,"0")).join("")}const z=async({method:t,bucket:e,path:s,region:u,accessKey:y,secretKey:l,endpoint:p,payload:m,contentType:k})=>{const i=new Date().toISOString().replace(/[:\-]|\.\d{3}/g,""),c=i.slice(0,8),o=new URL(p).host;let a;p.endsWith("/")&&(p=p.slice(0,-1)),p.includes(e)?a=new URL(`${p}/${s}`):a=new URL(`${p}/${e}/${s}`);const n=a.pathname,h="";await x(typeof m=="string"?m:"");const w="UNSIGNED-PAYLOAD",d={host:o,"x-amz-content-sha256":w,"x-amz-date":i};d["content-type"]=k;const $=Object.keys(d).sort(),f=$.map(A=>`${A}:${d[A]}
`).join(""),S=$.join(";"),D=[t,n,h,f,S,w].join(`
`),T=`${c}/${u}/s3/aws4_request`,v=["AWS4-HMAC-SHA256",i,T,await x(D)].join(`
`),U=await b(new TextEncoder().encode(`AWS4${l}`),c),g=await b(U,u),P=await b(g,"s3"),j=await b(P,"aws4_request"),C=_(await b(j,v)),O=`AWS4-HMAC-SHA256 Credential=${y}/${T}, SignedHeaders=${S}, Signature=${C}`;return fetch(a.toString(),{method:t,headers:{...d,Authorization:O},body:m})},B={async uploadFile(t,e,s){var u,y,l,p,m,k;if(!t.credentials)throw new Error("Missing credentials for storage provider.");if(t.type==="webdav"){const{username:r,password:i}=t.credentials,o=`${t.endpoint.replace(/\/$/,"")}/${s}`,a={"Content-Type":e.type||"application/octet-stream"};r&&i&&(a.Authorization="Basic "+btoa(`${r}:${i}`));const n=await fetch(o,{method:"PUT",headers:a,body:e});if(!n.ok)throw new Error(`WebDAV Error: ${n.status} ${n.statusText}`);return t.publicUrlPrefix?`${t.publicUrlPrefix.replace(/\/$/,"")}/${s}`:o}if(t.type==="s3"){const{accessKey:r,secretKey:i}=t.credentials;if(!r||!i||!t.bucket)throw new Error("Incomplete S3 Config");if(await z({method:"PUT",bucket:t.bucket,region:t.region||"us-east-1",endpoint:t.endpoint,path:s,accessKey:r,secretKey:i,payload:e,contentType:e.type||"application/octet-stream"}),t.publicUrlPrefix)return`${t.publicUrlPrefix.replace(/\/$/,"")}/${s}`;let c=t.endpoint.replace(/\/$/,"");return c.includes(t.bucket)?`${c}/${s}`:`${c}/${t.bucket}/${s}`}if(t.type==="custom_http"){const r=(u=t.credentials)==null?void 0:u.token,i=t.customHeaderName||"Authorization",c=t.responsePath||"url",o=new FormData;o.append("file",e,s);const a={};r&&(a[i]=r);const n=await fetch(t.endpoint,{method:"POST",headers:a,body:o});if(!n.ok)throw new Error(`API Error: ${n.status} ${n.statusText}`);let h;try{h=await n.json()}catch{const f=await n.text();if(f.startsWith("http"))return f.trim();throw new Error("Response was not JSON and not a URL.")}const w=N(h,c);if(!w)throw new Error(`Could not find URL at property '${c}' in response.`);const d=String(w);if(d.startsWith("/"))try{return`${new URL(t.endpoint).origin}${d}`}catch{return d}return d}if(t.type==="google_drive"){const r=(y=t.credentials)==null?void 0:y.accessToken;if(!r)throw new Error("Not connected to Google Drive");const i={name:s,mimeType:e.type||"application/octet-stream"},c=new FormData;c.append("metadata",new Blob([JSON.stringify(i)],{type:"application/json"})),c.append("file",e);const o=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webContentLink,webViewLink",{method:"POST",headers:{Authorization:`Bearer ${r}`},body:c});if(!o.ok){const n=await o.json();throw new Error(`Google Drive Error: ${((l=n.error)==null?void 0:l.message)||o.statusText}`)}const a=await o.json();return await fetch(`https://www.googleapis.com/drive/v3/files/${a.id}/permissions`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})}),a.webContentLink||a.webViewLink}if(t.type==="dropbox"){const r=(p=t.credentials)==null?void 0:p.accessToken;if(!r)throw new Error("Not connected to Dropbox");const i=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Dropbox-API-Arg":JSON.stringify({path:`/${s}`,mode:"add",autorename:!0,mute:!1}),"Content-Type":"application/octet-stream"},body:e});if(!i.ok){const h=await i.text();throw new Error(`Dropbox Upload Error: ${h}`)}const o=(await i.json()).path_display,a=await fetch("https://api.dropboxapi.com/2/sharing/create_shared_link_with_settings",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({path:o})});let n="";if(a.ok)n=(await a.json()).url;else if((await a.json()).error[".tag"]==="shared_link_already_exists"){const d=await(await fetch("https://api.dropboxapi.com/2/sharing/list_shared_links",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({path:o})})).json();d.links&&d.links.length>0&&(n=d.links[0].url)}if(n)return n.replace("dl=0","raw=1");throw new Error("Could not generate public link for Dropbox file.")}if(t.type==="onedrive"){const r=(m=t.credentials)==null?void 0:m.accessToken;if(!r)throw new Error("Not connected to OneDrive");const c=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${encodeURIComponent(s)}:/content`,o=await fetch(c,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":e.type||"application/octet-stream"},body:e});if(!o.ok){const w=await o.json();throw new Error(`OneDrive Error: ${((k=w.error)==null?void 0:k.message)||o.statusText}`)}const a=await o.json(),n=a.id,h=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${n}/createLink`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({type:"view",scope:"anonymous"})});return h.ok?(await h.json()).link.webUrl:a.webUrl}throw t.type==="icloud"?new Error("Direct iCloud REST upload is not currently supported without CloudKit JS container configuration."):new Error(`Unknown storage type: ${t.type}`)},async testConnection(t){var e,s,u,y;try{if(t.type==="google_drive"){if(!((e=t.credentials)!=null&&e.accessToken))throw new Error("No token");if(!(await fetch("https://www.googleapis.com/drive/v3/files?pageSize=1",{headers:{Authorization:`Bearer ${t.credentials.accessToken}`}})).ok)throw new Error("Drive API call failed");return!0}if(t.type==="dropbox"){if(!((s=t.credentials)!=null&&s.accessToken))throw new Error("No token");if(!(await fetch("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${t.credentials.accessToken}`}})).ok)throw new Error("Dropbox API call failed");return!0}if(t.type==="onedrive"){if(!((u=t.credentials)!=null&&u.accessToken))throw new Error("No token");if(!(await fetch("https://graph.microsoft.com/v1.0/me/drive",{headers:{Authorization:`Bearer ${t.credentials.accessToken}`}})).ok)throw new Error("OneDrive API call failed");return!0}if(t.type==="icloud"){if(!((y=t.credentials)!=null&&y.accessToken))throw new Error("No iCloud token present.");return!0}const l=new Blob(["connection_test"],{type:"text/plain"});return await this.uploadFile(t,l,"notesdb_test.txt"),!0}catch(l){throw console.error("Storage Test Failed",l),l}}};export{B as s};
