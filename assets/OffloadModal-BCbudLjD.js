import{r as o,j as e,U as L,X as P,i as G,Q as z,L as H,e as Q,Z as X,d as x}from"./index-KKYn1hr3.js";import{s as Y}from"./storage-CLUXANlV.js";import"./vendor-B7FnPyzq.js";const B=({files:h,linkedNotes:S,initialProviderId:m,onClose:j,onComplete:k})=>{const[g,C]=o.useState([]),[v,u]=o.useState(""),[t,p]=o.useState("idle"),[$,b]=o.useState(0),[U,A]=o.useState(""),[O,N]=o.useState(null),[R,E]=o.useState(0);o.useEffect(()=>{(async()=>{const a=((await x.getSettings()).storageConfigs||[]).filter(s=>s.active);C(a),m&&a.find(s=>s.id===m)?u(m):a.length>0&&u(a[0].id)})()},[m]);const F=async()=>{const n=g.find(s=>s.id===v);if(!n)return;p("uploading"),N(null);let f=0;const a={};try{for(const i of h){A(i.fileName);const l=await x.getAttachment(i.id);if(!l){console.warn(`Skipping missing attachment: ${i.id}`);continue}const r=i.fileName.split(".").pop()||"bin",c=`${i.id}.${r}`,d=await Y.uploadFile(n,l.blob,c);a[i.id]=d,f++,b(f/h.length*50)}p("patching");const s=await x.getNotes();let w=0;const D=s.length;for(const i of s){let l=i.content,r=!1;for(const[c,d]of Object.entries(a)){const y=new RegExp(`src="attachment:${c}"`,"g");if(y.test(l)&&(l=l.replace(y,`src="${d}"`),r=!0),l.includes(`id="${c}"`)&&l.includes("file-attachment")){const M=new RegExp(`<file-attachment[^>]*id="${c}"[^>]*>.*?</file-attachment>`,"g"),T=`<a href="${d}" target="_blank" class="offloaded-file flex items-center gap-2 p-2 border rounded bg-zinc-900 text-indigo-400 hover:underline">ðŸ“„ ${d.split("/").pop()}</a>`;l=l.replace(M,T),r=!0}}r&&(await x.saveNote({...i,content:l,updatedAt:Date.now()}),w++),b(50+w/D*40)}for(const i of Object.keys(a))await x.deleteAttachment(i);b(100),E(f),p("complete")}catch(s){console.error(s),p("error"),N(s.message||"Operation failed.")}};return e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"w-full max-w-lg bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-zinc-800 bg-zinc-900/50",children:[e.jsxs("h3",{className:"text-sm font-bold text-white flex items-center gap-2",children:[e.jsx(L,{size:16,className:"text-indigo-400"}),"Offload Attachments"]}),e.jsx("button",{onClick:j,disabled:t==="uploading"||t==="patching",className:"text-zinc-500 hover:text-white transition-colors",children:e.jsx(P,{size:18})})]}),e.jsxs("div",{className:"p-6",children:[t==="idle"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-indigo-500/10 border border-indigo-500/20 rounded-lg p-3 flex gap-3",children:[e.jsx(G,{size:20,className:"text-indigo-400 shrink-0 mt-1"}),e.jsxs("div",{className:"text-xs text-indigo-200 leading-relaxed",children:[e.jsx("p",{className:"font-bold mb-1",children:"Save Local Space"}),"You are about to move ",e.jsxs("strong",{children:[h.length," file",h.length!==1&&"s"]})," to external storage. This will:",e.jsxs("ul",{className:"list-disc pl-4 mt-1 opacity-80",children:[e.jsx("li",{children:"Upload files to the selected provider"}),e.jsxs("li",{children:["Update ",e.jsxs("strong",{children:[S.length," notes"]})," with public links"]}),e.jsx("li",{children:"Delete the local copies to free up space"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] uppercase font-bold text-zinc-500",children:"Destination Provider"}),g.length>0?e.jsx("select",{value:v,onChange:n=>u(n.target.value),className:"w-full bg-black border border-zinc-700 rounded p-2 text-xs text-white outline-none focus:border-indigo-500",children:g.map(n=>e.jsxs("option",{value:n.id,children:[n.name," (",n.type,")"]},n.id))}):e.jsxs("div",{className:"p-2 border border-red-500/30 bg-red-500/10 rounded text-xs text-red-400 flex items-center gap-2",children:[e.jsx(z,{size:14}),"No storage providers configured. Go to Settings."]})]})]}),(t==="uploading"||t==="patching")&&e.jsxs("div",{className:"py-8 text-center space-y-4",children:[e.jsx(H,{size:32,className:"text-indigo-500 animate-spin mx-auto"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-white mb-1",children:t==="uploading"?"Uploading Files...":"Updating Notes..."}),e.jsx("p",{className:"text-xs text-zinc-500 font-mono",children:t==="uploading"?`Processing: ${U}`:"Replacing local references with remote links"})]}),e.jsx("div",{className:"w-full h-2 bg-zinc-800 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-indigo-500 transition-all duration-300",style:{width:`${$}%`}})})]}),t==="complete"&&e.jsxs("div",{className:"py-6 text-center space-y-4",children:[e.jsx("div",{className:"w-12 h-12 bg-emerald-500/20 text-emerald-500 rounded-full flex items-center justify-center mx-auto",children:e.jsx(Q,{size:24})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-white",children:"Offload Complete"}),e.jsxs("p",{className:"text-xs text-zinc-500 mt-1",children:["Successfully moved ",R," files."]})]})]}),t==="error"&&e.jsxs("div",{className:"py-6 text-center space-y-4",children:[e.jsx("div",{className:"w-12 h-12 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center mx-auto",children:e.jsx(z,{size:24})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-white",children:"Offload Failed"}),e.jsx("p",{className:"text-xs text-red-400 mt-1 px-4",children:O})]})]})]}),e.jsxs("div",{className:"p-4 bg-zinc-950 border-t border-zinc-800 flex justify-end gap-3",children:[t==="idle"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:j,className:"px-4 py-2 text-zinc-400 hover:text-white text-xs font-bold transition-colors",children:"Cancel"}),e.jsxs("button",{onClick:F,disabled:g.length===0,className:"flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-xs font-bold transition-all",children:["Start Transfer ",e.jsx(X,{size:14})]})]}),(t==="complete"||t==="error")&&e.jsx("button",{onClick:k,className:"flex items-center gap-2 px-6 py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg text-xs font-bold transition-colors",children:"Close"})]})]})})};export{B as default};
